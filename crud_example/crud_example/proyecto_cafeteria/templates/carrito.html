{% extends 'base.html' %}

{% block title %}Mi Carrito - Cafeter√≠a{% endblock %}

{% block extra_css %}
<style>
    .cart-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
        align-items: start;
    }

    .cart-items {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .cart-title {
        font-size: 2rem;
        font-weight: 900;
        margin-bottom: 2rem;
        color: var(--dark);
    }

    .cart-item {
        display: flex;
        gap: 1.5rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 16px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .cart-item:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .item-image {
        width: 100px;
        height: 100px;
        border-radius: 12px;
        object-fit: cover;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .item-details {
        flex: 1;
    }

    .item-name {
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.5rem;
    }

    .item-extras {
        color: #636e72;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .item-price {
        font-size: 1.3rem;
        font-weight: 800;
        color: var(--success);
    }

    .item-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: flex-end;
    }

    .quantity-mini {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: white;
        padding: 0.5rem;
        border-radius: 12px;
    }

    .qty-mini-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 2px solid var(--secondary);
        background: white;
        color: var(--secondary);
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .qty-mini-btn:hover {
        background: var(--secondary);
        color: white;
    }

    .qty-mini-display {
        font-weight: 800;
        font-size: 1.1rem;
        min-width: 30px;
        text-align: center;
    }

    .remove-btn {
        background: none;
        border: none;
        color: var(--danger);
        cursor: pointer;
        font-size: 1.5rem;
        transition: all 0.3s ease;
    }

    .remove-btn:hover {
        transform: scale(1.2);
    }

    .cart-summary {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        position: sticky;
        top: 100px;
    }

    .summary-title {
        font-size: 1.5rem;
        font-weight: 900;
        margin-bottom: 1.5rem;
        color: var(--dark);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 1rem 0;
        border-bottom: 1px solid var(--light);
    }

    .summary-row:last-of-type {
        border-bottom: 3px solid var(--secondary);
    }

    .summary-label {
        color: #636e72;
        font-weight: 600;
    }

    .summary-value {
        font-weight: 800;
        color: var(--dark);
    }

    .total-row {
        padding: 1.5rem 0;
        margin-top: 1rem;
    }

    .total-row .summary-label {
        font-size: 1.3rem;
        color: var(--dark);
    }

    .total-row .summary-value {
        font-size: 1.8rem;
        color: var(--success);
    }

    .promo-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 12px;
        margin: 1rem 0;
        text-align: center;
        font-weight: 700;
    }

    .eta-info {
        background: rgba(116, 185, 255, 0.1);
        padding: 1rem;
        border-radius: 12px;
        margin: 1rem 0;
        text-align: center;
    }

    .eta-info strong {
        color: #01579b;
    }

    .checkout-btn {
        width: 100%;
        padding: 1.5rem;
        background: linear-gradient(135deg, var(--success), #55efc4);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 1.2rem;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(0, 184, 148, 0.3);
        margin-top: 1.5rem;
    }

    .checkout-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 184, 148, 0.4);
    }

    .empty-cart {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-cart-icon {
        font-size: 6rem;
        margin-bottom: 1.5rem;
        opacity: 0.3;
    }

    @media (max-width: 1024px) {
        .cart-container {
            grid-template-columns: 1fr;
        }

        .cart-summary {
            position: static;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="cart-container">
    <div class="cart-items">
        <h1 class="cart-title">üõí Mi Carrito</h1>

        {% if items %}
            {% for item in items %}
            <div class="cart-item">
                <img src="{% if item.producto.imagen %}{{ item.producto.imagen.url }}{% else %}data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%23ddd' width='100' height='100'/%3E%3Ctext fill='%23999' x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='40'%3E‚òï%3C/text%3E%3C/svg%3E{% endif %}" 
                     alt="{{ item.producto.nombre }}" 
                     class="item-image">
                
                <div class="item-details">
                    <div class="item-name">{{ item.producto.nombre }}</div>
                    
                    {% if item.tamano %}
                    <div class="item-extras">üìè {{ item.tamano.nombre }}</div>
                    {% endif %}
                    
                    {% if item.extras_seleccionados.all %}
                    <div class="item-extras">
                        ‚ûï {% for extra in item.extras_seleccionados.all %}{{ extra.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if item.personalizacion %}
                    <div class="item-extras">üìù {{ item.personalizacion }}</div>
                    {% endif %}
                    
                    <div class="item-price">${{ item.get_precio_total|floatformat:0 }}</div>
                </div>

                <div class="item-actions">
                    <div class="quantity-mini">
                        <button class="qty-mini-btn btn-decrease" data-item-id="{{ item.id }}">‚àí</button>
                        <span class="qty-mini-display" id="qty-{{ item.id }}">{{ item.cantidad }}</span>
                        <button class="qty-mini-btn btn-increase" data-item-id="{{ item.id }}">+</button>
                    </div>
                    <button class="remove-btn btn-remove" data-item-id="{{ item.id }}" title="Eliminar">üóëÔ∏è</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-cart">
                <div class="empty-cart-icon">üõí</div>
                <h2>Tu carrito est√° vac√≠o</h2>
                <p style="color: #636e72; margin: 1rem 0 2rem;">Agrega algunos productos deliciosos</p>
                <a href="{% url 'cafeteria:menu_principal' %}" class="btn btn-primary">Ver men√∫</a>
            </div>
        {% endif %}
    </div>

    {% if items %}
    <div class="cart-summary">
        <h2 class="summary-title">Resumen</h2>

        {% if promocion_aplicada %}
        <div class="promo-badge">
            üéì {{ promocion_aplicada.nombre }}<br>
            <small>{{ promocion_aplicada.porcentaje_descuento }}% de descuento aplicado</small>
        </div>
        {% endif %}

        <div class="summary-row">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value">${{ subtotal|floatformat:0 }}</span>
        </div>

        <div class="summary-row">
            <span class="summary-label">Impuestos (10%)</span>
            <span class="summary-value">${{ impuestos|floatformat:0 }}</span>
        </div>

        {% if descuento > 0 %}
        <div class="summary-row">
            <span class="summary-label" style="color: var(--success);">Descuento</span>
            <span class="summary-value" style="color: var(--success);">-${{ descuento|floatformat:0 }}</span>
        </div>
        {% endif %}

        <div class="summary-row total-row">
            <span class="summary-label">TOTAL</span>
            <span class="summary-value">${{ total|floatformat:0 }}</span>
        </div>

        <div class="eta-info">
            <strong>‚è±Ô∏è Tiempo estimado:</strong><br>
            ~{{ tiempo_estimado }} minutos
        </div>

        <a href="{% url 'cafeteria:resumen_pago' %}" class="checkout-btn">
            Continuar con el pago ‚Üí
        </a>
    </div>
    {% endif %}
</div>

<script>
    function actualizarCantidad(itemId, accion) {
        const formData = new FormData();
        formData.append('item_id', itemId);
        formData.append('accion', accion);

        fetch('{% url "cafeteria:actualizar_cantidad_carrito" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.eliminado) {
                    location.reload();
                } else {
                    document.getElementById('qty-' + itemId).textContent = data.nueva_cantidad;
                    location.reload(); // Recargar para actualizar totales
                }
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function eliminarItem(itemId) {
        if (!confirm('¬øEliminar este producto del carrito?')) return;

        const formData = new FormData();
        formData.append('item_id', itemId);

        fetch('{% url "cafeteria:eliminar_item_carrito" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}